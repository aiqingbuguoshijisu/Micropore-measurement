#include "Microporemeasurement.h"
#include "libxl.h"
#include "best_fit.h"
#include"tool.h"
static string yz_filepath = "F:/2026project/yzcloud.txt";
static string pm_filepath = "F:/2026project/pmcloud_p.txt";
static Matrix3d covariance_matrix_yz{ {6.4e-13 / sqrt(2) / 3,0.0,0.0},
								{0.0,6.4e-13 / sqrt(2) / 3,0.0},
								{0.0,0.0,2.25e-13 / 3} };
static Matrix3d covariance_matrix_pm{ {6.4e-13 / sqrt(2) / 3,0.0,0.0},
								{0.0,6.4e-13 / sqrt(2) / 3,0.0},
								{0.0,0.0,2.25e-13 / 3} };
static Vector3d z_axis = { 0.0,0.0,1.0 };
Microporemeasurement::Microporemeasurement(QWidget *parent)
    : QMainWindow(parent)
{
    ui.setupUi(this);
	connect(ui.ClickToCompute, &QPushButton::clicked, this, &Microporemeasurement::ClickedToCompute);
   // connect//评定过程计算
   // (
   //     ui.ClickToCompute, &QPushButton::clicked, [=]()
   //     {
			////string yz_file_path = "F:\\2026project\\yzcloud_rotated.txt";
			////string pm_file_path = "F:\\2026project\\pmcloud_p_rotated.txt";
			////pair<Points3d, Points3d> result = oridataprocess(yz_file_path, pm_file_path);
			////cout << "yz cloud size: " << result.first.size() << endl;
			////cout << "pm cloud size: " << result.second.size() << endl;
			////Points3d yzdata = readPointsFromFile("F:\\2026project\\yzcloud_rotated.txt"); 
			////Points3d pmdata = readPointsFromFile("F:\\2026project\\pmcloud_p_rotated.txt");
			////Matrix3d R_yz{ {0.20702669, -0.35599566, -0.91126672},
			////				{-0.35599566,  0.84018011, -0.40910204},
			////				{0.91126672  ,0.40910204 , 0.0472068} };
			////Matrix3d R_pm{ {0.97487799 , 0.10913943 , 0.19416872},
			////				{0.10913943 , 0.52585742 ,-0.84354168},
			////				{-0.19416872 , 0.84354168 , 0.50073541} };
			////vector<double> D;//存放微孔直径
			////vector<double> ang;//存放微孔位置倾角
			////vector<Points3d> fit;//存放圆柱抽样点云
			////vector<Points3d> plane_points;//存放平面抽样点云
			////int sample_nums = 3;
			////for (int k = 0; k < sample_nums; k++)
			////{
			////	Points3d results_yz;
			////	Points3d results_pm;
			////	for (int i = 0; i < yzdata.size(); i++)
			////	{
			////		Point3d sample_point = sample_elliptical_cylinder(covariance_matrix_yz, yzdata[i]);
			////		results_yz.push_back(sample_point);
			////	}
			////	fit.push_back(results_yz);
			////	for (int i = 0; i < pmdata.size(); i++)
			////	{
			////		Point3d sample_point = sample_elliptical_cylinder(covariance_matrix_pm, pmdata[i]);
			////		sample_point = R_pm.transpose() * sample_point;
			////		results_pm.push_back(sample_point);
			////	}
			////	plane_points.push_back(results_pm);
			////}
			////for (int j = 0; j < fit.size(); j++)
			////{
			////	tuple<Vector3d, Point3d, double, double> bf = _best_fit(fit[j]);
			////	D.push_back(get<2>(bf) * 2);
			////	Vector3d plane_normal = get_plane_normal(plane_points[j]);
			////	if (plane_normal[2] < 0)
			////	{
			////		plane_normal = -plane_normal.normalized();
			////	}
			////	plane_normal = plane_normal.normalized();
			////	Vector3d yz_normal = get<0>(bf);
			////	if (yz_normal[2] < 0)
			////	{
			////		yz_normal = -yz_normal.normalized();
			////	}
			////	yz_normal = yz_normal.normalized();
			////	double angle = compute_angle_between_vectors(plane_normal, yz_normal);
			////	ang.push_back(angle);
			////}
			////ui.ReceiveDiameterMean->setText(QString::number(calculateMean(D)));
			////ui.ReceiveDiameterStd->setText(QString::number(calculateStandardDeviation(D, calculateMean(D))));
			////ui.ReceiveAngleMean->setText(QString::number(calculateMean(ang)));
			////ui.ReceiveAngleStd->setText(QString::number(calculateStandardDeviation(ang, calculateMean(ang))));
   //     }
   // );
}

void Microporemeasurement::ClickedToCompute()
{
	auto data = oridataprocess(yz_filepath, pm_filepath, 12000);
	Points3d yzdata = data.first;
	Points3d pmdata = data.second;

	Vector3d plane_vec = get_plane_normal(pmdata);
	double angle_pm_z = compute_angle_between_vectors(plane_vec, z_axis);
	Matrix3d R_pm = compute_rotation_matrix(plane_vec, angle_pm_z * M_PI / 180.0);

	queue <Points3d> yz_queue;//共享队列
	queue <Points3d> pm_queue;//共享队列
	mutex mtx_yz, mtx_pm;//互斥锁,保护两个队列
	condition_variable cvSample;//抽样条件变量
	condition_variable cvCompute;//计算条件变量
	bool isSampleFinished = false;
	int sample_nums = 10;

	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

}


Microporemeasurement::~Microporemeasurement()
{}
